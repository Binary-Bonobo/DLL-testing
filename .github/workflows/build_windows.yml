name: Build WinlatorXRBridge

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Ensure lib folder exists
      run: |
        if (-Not (Test-Path lib)) {
          Write-Host "lib folder missing, creating..."
          New-Item -ItemType Directory -Path lib
        } else {
          Write-Host "lib folder exists, skipping creation"
        }
      shell: powershell

    - name: Verify HarmonyLib.dll
      run: |
        if (-Not (Test-Path lib\HarmonyLib.dll)) {
          Write-Error "HarmonyLib.dll is missing in lib/. Please add it to the repo."
        } else {
          Write-Host "HarmonyLib.dll found, using committed DLL"
        }
      shell: powershell

    - name: Build WinlatorXRBridge DLL
      run: |
        msbuild src/WinlatorXRBridge/WinlatorXRBridge.csproj /p:Configuration=Release
      shell: powershell

    - name: Zip artifacts
      run: |
        $artifactPath = "$PWD\artifacts"
        if (-Not (Test-Path $artifactPath)) {
          Write-Error "Build failed or artifacts folder missing."
          exit 1
        }
        Compress-Archive -Path "$artifactPath\*" -DestinationPath "$PWD\WinlatorXRBridge.zip" -Force
      shell: powershell

    - name: Upload DLL zip
      uses: actions/upload-artifact@v3
      with:
        name: WinlatorXRBridge
        path: WinlatorXRBridge.zip
